<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã“ã“ã‚ã®ã‚³ãƒ³ãƒ‘ã‚¹</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&family=Mochiy+Pop+One&display=swap');
        :root {
            --bg-main: #FAF7F2;
            --bg-container: #FFFFFF;
            --bg-form-area: #FFFDF9;
            --text-primary: #5D4037;
            --text-secondary: #8D6E63;
            --accent-main: #FFCC80;
            --accent-gentle: #FFE0B2;
            --border-color: #E0D8CF;
            --font-body: 'Kiwi Maru', serif;
            --font-heading: 'Mochiy Pop One', sans-serif;
            /* æ„Ÿæƒ…ã®è‰² */
            --emotion-happy: #AED581;        /* ğŸ˜Š ã†ã‚Œã—ã„ */
            --emotion-calm: #B2DFDB;         /* ğŸ˜Œ ãŠã ã‚„ã‹ */
            --emotion-neutral: #E0E0E0;      /* ğŸ™‚ ãµã¤ã† */
            --emotion-sad: #B0BEC5;          /* ğŸ˜¢ ã‹ãªã—ã„ */
            --emotion-frustrated: #FFCCBC;  /* ğŸ˜  ã‚¤ãƒ©ã‚¤ãƒ© */
            --emotion-lonely: #A4B8BF;     /* ğŸ˜” ã•ã¿ã—ã„ (æ–°ã—ã„è‰²) */
            /* ä»–ã®æ„Ÿæƒ…è‰²ã‚‚å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«è¿½åŠ  */
            --emotion-very-happy: #FFF176;
            --emotion-fun: #A5D6A7;
            --emotion-tired: #CFD8DC;
            --emotion-very-sad: #90A4AE;
            --emotion-anxious: #D1C4E9;
            --emotion-other: #D7CCC8;
        }
        body { font-family: var(--font-body); margin: 0; padding: 15px; background-color: var(--bg-main); color: var(--text-primary); line-height: 1.7; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .app-wrapper { width: 100%; max-width: 580px; }
        .container { background-color: var(--bg-container); padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.07); margin-bottom: 20px; border: 1px solid var(--border-color); }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: var(--font-heading); font-size: 2em; margin-bottom: 5px; }
        header .subtitle { font-size: 0.9em; color: var(--text-secondary); }
        .section-title { font-family: var(--font-heading); color: var(--text-primary); margin-top:0; margin-bottom: 15px; font-size: 1.3em; text-align: center; padding-bottom: 5px; border-bottom: 1px dotted var(--accent-gentle); }
        
        .form-area { padding: 15px; background-color: var(--bg-form-area); border-radius: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group:last-child { margin-bottom: 0; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.85em; }
        
        .emotion-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .emotion-button { background-color: #fff; border: 2px solid var(--border-color); color: var(--text-secondary); padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 0.8em; transition: all 0.15s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 60px; }
        .emotion-button .emotion-icon { font-size: 1.5em; margin-bottom: 3px; }
        .emotion-button.selected { border-width: 2px; font-weight: bold; color: var(--text-primary); transform: scale(1.02); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        
        textarea#diary-memo-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: #fff; color: var(--text-primary); font-size: 0.9em; font-family: var(--font-body); min-height: 70px; resize: vertical; box-sizing: border-box; }
        textarea#diary-memo-input:focus { outline: none; border-color: var(--accent-main); box-shadow: 0 0 0 2px rgba(255, 204, 128, 0.3); }

        /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .photo-upload-area { margin-top: 10px; padding: 15px; border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; background-color: #fff; transition: border-color 0.2s ease; }
        .photo-upload-area:hover { border-color: var(--accent-main); }
        .photo-upload-area.dragover { border-color: var(--accent-main); background-color: var(--accent-gentle); }
        #photo-input { display: none; }
        .photo-upload-button { display: inline-block; padding: 8px 16px; background-color: var(--accent-gentle); color: var(--text-primary); border: 1px solid var(--accent-main); border-radius: 6px; cursor: pointer; font-size: 0.85em; font-family: var(--font-body); transition: background-color 0.2s ease; }
        .photo-upload-button:hover { background-color: var(--accent-main); }
        .photo-preview { margin-top: 10px; max-width: 200px; max-height: 200px; border-radius: 6px; object-fit: cover; }
        .photo-remove-button { margin-top: 5px; padding: 4px 8px; background-color: #ffebee; border: 1px solid #ef9a9a; color: #c62828; border-radius: 4px; cursor: pointer; font-size: 0.75em; }

        button[type="submit"] { display: block; width: 100%; margin-top: 15px; padding: 10px 15px; background-color: var(--accent-main); color: var(--text-primary); border: none; border-radius: 20px; cursor: pointer; font-size: 0.95em; font-weight: 700; font-family: var(--font-heading); transition: background-color 0.2s ease, transform 0.1s ease; }
        button[type="submit"]:hover { background-color: #FFA726; transform: translateY(-1px); }
        button[type="submit"]:active { transform: translateY(0px); }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .filter-section { margin-bottom: 20px; padding: 15px; background-color: var(--bg-form-area); border-radius: 10px; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 150px; }
        .filter-label { font-size: 0.8em; color: var(--text-secondary); font-weight: 500; }
        .filter-select { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background-color: #fff; color: var(--text-primary); font-size: 0.85em; font-family: var(--font-body); cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--accent-main); box-shadow: 0 0 0 2px rgba(255, 204, 128, 0.3); }

        .diary-list { list-style: none; padding: 0; margin-top: 20px; }
        .diary-list li {
            background-color: #fff; padding: 12px 15px; margin-bottom: 10px;
            border-radius: 8px; border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; align-items: flex-start; gap: 10px;
        }
        .diary-list li .entry-emotion-icon-display { font-size: 1.6em; flex-shrink: 0; width: 30px; text-align: center; margin-top: 2px; }
        .diary-list li .entry-text-content { flex-grow: 1; }
        .diary-list li .entry-memo-text { font-size: 0.9em; color: var(--text-primary); margin-bottom: 8px; white-space: pre-wrap; word-break: break-word; }
        .diary-list li .entry-date { font-size: 0.75em; color: var(--text-secondary); margin-bottom: 8px; }
        .diary-list li .entry-photo { max-width: 200px; max-height: 150px; border-radius: 6px; object-fit: cover; margin-bottom: 8px; cursor: pointer; }
        .diary-list li .entry-actions { flex-shrink: 0; margin-top: 2px; }
        .delete-button { 
            background-color: #ffebee; 
            border: 1px solid #ef9a9a; 
            color: #c62828; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.7em; 
            font-family: var(--font-body);
            transition: all 0.2s ease;
        }
        .delete-button:hover { 
            background-color: #ffcdd2; 
            border-color: #e57373; 
        }
        
        .message-box { padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-size: 0.8em; border-width: 1px; border-style: solid; display:none;}
        .info-message { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error-message { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .no-diary-message { text-align: center; color: var(--text-secondary); padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px dashed var(--border-color); }
        #error-log-display { color: red; white-space: pre-wrap; border: 1px solid red; padding: 10px; margin-top: 20px; background-color: #fff0f0; display: none; }
        .privacy-note { font-size: 0.8em; color: var(--text-secondary); text-align: center; margin-top: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 6px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh; }
        .modal-content img { width: 100%; height: auto; border-radius: 8px; }
        .modal-close { position: absolute; top: 10px; right: 15px; color: white; font-size: 28px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="container">
            <header>
                <h1>ã“ã“ã‚ã®ã‚³ãƒ³ãƒ‘ã‚¹</h1>
                <p class="subtitle">ä»Šæ—¥ã®ãã‚‚ã¡ã‚’ã€ã®ã“ãã†</p>
            </header>

            <div id="info-display" class="message-box info-message"></div>
            <div id="error-log-display" class="error-message"></div>

            <section class="form-section">
                <h2 class="section-title">ä»Šã®ã‚ãŸã—</h2>
                <div class="form-area">
                    <form id="diary-form">
                        <div class="form-group">
                            <label>ã©ã‚“ãªãã‚‚ã¡ï¼Ÿ (ã²ã¨ã¤ãˆã‚‰ã‚“ã§ã­)</label>
                            <div class="emotion-selector" id="emotion-selector-buttons">
                                <!-- JSã§æ„Ÿæƒ…ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ -->
                            </div>
                            <input type="hidden" id="selected-emotion-value">
                        </div>
                        <div class="form-group">
                            <label for="diary-memo-input">ã²ã¨ã“ã¨ (æ€ã£ãŸã“ã¨ã€ã‚ã£ãŸã“ã¨)</label>
                            <textarea id="diary-memo-input" rows="3" placeholder="ã„ã¾ã€ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å¿ƒã«æ®‹ã£ãŸä¸€æš (ã‚ã‚Œã°)</label>
                            <div class="photo-upload-area" id="photo-upload-area">
                                <input type="file" id="photo-input" accept="image/*">
                                <label for="photo-input" class="photo-upload-button">ğŸ“· å†™çœŸã‚’é¸ã¶</label>
                                <p style="margin: 5px 0 0 0; font-size: 0.75em; color: var(--text-secondary);">ã¾ãŸã¯ã€ã“ã“ã«å†™çœŸã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                                <div id="photo-preview-container"></div>
                            </div>
                        </div>
                        <button type="submit">ã®ã“ã™</button>
                    </form>
                </div>
            </section>
        </div>

        <div class="container list-section">
            <h2 class="section-title">ã“ã‚Œã¾ã§ã®ã‚ãŸã—</h2>
            <div class="filter-section">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">ãã‚‚ã¡</label>
                        <select id="emotion-filter" class="filter-select">
                            <option value="all">ã™ã¹ã¦</option>
                            <!-- JSã§æ„Ÿæƒ…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">æœˆ</label>
                        <select id="month-filter" class="filter-select">
                            <option value="all">ã™ã¹ã¦</option>
                            <!-- JSã§æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ -->
                        </select>
                    </div>
                </div>
            </div>
            <ul id="diary-list-ul" class="diary-list"></ul>
        </div>
        
        <div class="privacy-note container">
            <p><strong>å®‰å¿ƒã—ã¦ã­ã€‚</strong>ã“ã“ã«æ›¸ã„ãŸã“ã¨ã¯ã€ã‚ãªãŸã®ç«¯æœ«ã®ä¸­ã«ã ã‘ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>

    <!-- å†™çœŸæ‹¡å¤§è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="photo-modal" class="modal">
        <span class="modal-close">&times;</span>
        <div class="modal-content">
            <img id="modal-image" src="" alt="">
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        window.onerror = function(message, source, lineno, colno, error) {
            const errorLog = document.getElementById('error-log-display');
            if (errorLog) {
                errorLog.textContent += `ãƒšãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼:\n${message}\nãƒ•ã‚¡ã‚¤ãƒ«: ${source}\nè¡Œ: ${lineno}, åˆ—: ${colno}\n\n`;
                errorLog.style.display = 'block';
            }
            console.error("ã‚­ãƒ£ãƒƒãƒã•ã‚Œãªã‹ã£ãŸã‚¨ãƒ©ãƒ¼:", message, "at", source, lineno, colno, error);
            return false;
        };

        // IndexedDBé–¢é€£
        class DiaryStorage {
            constructor() {
                this.dbName = 'KokoroCompassDB';
                this.dbVersion = 1;
                this.storeName = 'diaries';
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                            store.createIndex('emotion', 'emotion', { unique: false });
                        }
                    };
                });
            }

            async saveDiary(diary) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(diary);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }

            async getAllDiaries() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            async deleteDiary(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }
        }

        try {
            document.addEventListener('DOMContentLoaded', async () => {
                console.log("DOM Content Loaded. Enhanced Version Initializing...");

                const diaryForm = document.getElementById('diary-form');
                const emotionSelectorButtons = document.getElementById('emotion-selector-buttons');
                const selectedEmotionInput = document.getElementById('selected-emotion-value');
                const diaryMemoInput = document.getElementById('diary-memo-input');
                const diaryListUl = document.getElementById('diary-list-ul');
                const errorLogDisplay = document.getElementById('error-log-display');
                const infoDisplay = document.getElementById('info-display');
                const photoInput = document.getElementById('photo-input');
                const photoUploadArea = document.getElementById('photo-upload-area');
                const photoPreviewContainer = document.getElementById('photo-preview-container');
                const emotionFilter = document.getElementById('emotion-filter');
                const monthFilter = document.getElementById('month-filter');
                const photoModal = document.getElementById('photo-modal');
                const modalImage = document.getElementById('modal-image');
                const modalClose = document.querySelector('.modal-close');

                let initError = false;
                const requiredElements = [
                    { element: diaryForm, name: 'diary-form' },
                    { element: emotionSelectorButtons, name: 'emotion-selector-buttons' },
                    { element: selectedEmotionInput, name: 'selected-emotion-value' },
                    { element: diaryMemoInput, name: 'diary-memo-input' },
                    { element: diaryListUl, name: 'diary-list-ul' },
                    { element: photoInput, name: 'photo-input' },
                    { element: emotionFilter, name: 'emotion-filter' },
                    { element: monthFilter, name: 'month-filter' }
                ];

                const missing = requiredElements.filter(item => !item.element).map(item => item.name);
                if (missing.length > 0) {
                    console.error(`å¿…é ˆDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}`);
                    if (errorLogDisplay) {
                        errorLogDisplay.textContent = `ãƒšãƒ¼ã‚¸éƒ¨å“ä¸è¶³: ${missing.join(', ')}`;
                        errorLogDisplay.style.display = 'block';
                    }
                    initError = true;
                }
                if (initError) return;
                console.log("ä¸»è¦DOMè¦ç´ å–å¾—å®Œäº†ã€‚");

                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
                const storage = new DiaryStorage();
                try {
                    await storage.init();
                    console.log("IndexedDBåˆæœŸåŒ–å®Œäº†");
                } catch (error) {
                    console.error("IndexedDBåˆæœŸåŒ–å¤±æ•—:", error);
                    displayUserMessage('error-log-display', "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
                    return;
                }

                let diaries = [];
                let currentEmotionFilter = 'all';
                let currentMonthFilter = 'all';
                let selectedPhoto = null;

                // æ„Ÿæƒ…ã®é¸æŠè‚¢
                const emotions = [
                    { text: "ã¨ã£ã¦ã‚‚ãƒãƒƒãƒ”ãƒ¼ï¼", value: "ğŸ˜† ã¨ã£ã¦ã‚‚ãƒãƒƒãƒ”ãƒ¼ï¼", icon: "ğŸ˜†", colorVar: '--emotion-very-happy', selectedBg: '#FFF9C4' },
                    { text: "ã„ã„æ„Ÿã˜ãƒ»ã†ã‚Œã—ã„", value: "ğŸ˜Š ã„ã„æ„Ÿã˜ãƒ»ã†ã‚Œã—ã„", icon: "ğŸ˜Š", colorVar: '--emotion-happy',    selectedBg: '#DCEDC8' },
                    { text: "ãŸã®ã—ã„ï¼", value: "ğŸ˜„ ãŸã®ã—ã„ï¼", icon: "ğŸ˜„", colorVar: '--emotion-fun',      selectedBg: '#C8E6C9' },
                    { text: "ãŠã ã‚„ã‹ãƒ»ãƒ›ãƒƒã¨ã—ãŸ", value: "ğŸ˜Œ ãŠã ã‚„ã‹ãƒ»ãƒ›ãƒƒã¨ã—ãŸ", icon: "ğŸ˜Œ", colorVar: '--emotion-calm',     selectedBg: '#E0F2F1' },
                    { text: "ãªã‚“ã¨ãªããƒ»æ™®é€š", value: "ğŸ™‚ ãªã‚“ã¨ãªããƒ»æ™®é€š", icon: "ğŸ™‚", colorVar: '--emotion-neutral',  selectedBg: '#F5F5F5' },
                    { text: "ç–²ã‚ŒãŸãªâ€¦", value: "ğŸ˜• ç–²ã‚ŒãŸãªâ€¦", icon: "ğŸ˜•", colorVar: '--emotion-tired',    selectedBg: '#ECEFF1' },
                    { text: "ã¡ã‚‡ã£ã¨æ‚²ã—ã„", value: "ğŸ˜¢ ã¡ã‚‡ã£ã¨æ‚²ã—ã„", icon: "ğŸ˜¢", colorVar: '--emotion-sad',      selectedBg: '#E3F2FD' },
                    { text: "ã•ã¿ã—ã„ãƒ»ã‚€ãªã—ã„", value: "ğŸ˜” ã•ã¿ã—ã„ãƒ»ã‚€ãªã—ã„", icon: "ğŸ˜”", colorVar: '--emotion-lonely', selectedBg: 'rgba(164, 184, 191, 0.2)' },
                    { text: "ã™ã”ãã¤ã‚‰ã„", value: "ğŸ˜­ ã™ã”ãã¤ã‚‰ã„", icon: "ğŸ˜­", colorVar: '--emotion-very-sad', selectedBg: 'rgba(179, 157, 219, 0.2)' },
                    { text: "ä¸å®‰ãªãã‚‚ã¡", value: "ğŸ˜¥ ä¸å®‰ãªãã‚‚ã¡", icon: "ğŸ˜¥", colorVar: '--emotion-anxious',  selectedBg: 'rgba(225, 190, 231, 0.2)' },
                    { text: "ã‚¤ãƒ©ã‚¤ãƒ©ãƒ»ã‚‚ã‚„ã‚‚ã‚„", value: "ğŸ˜  ã‚¤ãƒ©ã‚¤ãƒ©ãƒ»ã‚‚ã‚„ã‚‚ã‚„", icon: "ğŸ˜ ", colorVar: '--emotion-irritable',selectedBg: 'rgba(255, 204, 188, 0.2)' },
                    { text: "ã‚ˆãã‚ã‹ã‚‰ãªã„", value: "ğŸ¤” ã‚ˆãã‚ã‹ã‚‰ãªã„", icon: "ğŸ¤”", colorVar: '--emotion-other',    selectedBg: 'rgba(215, 204, 200, 0.2)' }
                ];

                function sanitizeHTML(str) {
                    if (typeof str !== 'string') return '';
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                }

                function displayUserMessage(elementId, message, isError = false) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = message;
                        element.className = `message-box ${isError ? 'error-message' : 'info-message'}`;
                        element.style.display = 'block';
                        setTimeout(() => { element.style.display = 'none'; }, 3000);
                    }
                }

                function clearMessages() {
                    if (infoDisplay) infoDisplay.style.display = 'none';
                }

                // æ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•°
                function getWeekday(date) {
                    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                    return weekdays[date.getDay()];
                }

                // å†™çœŸã‚’Base64ã«å¤‰æ›
                function fileToBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }

                // æ„Ÿæƒ…ãƒœã‚¿ãƒ³ã®æç”»
                function renderEmotionButtons() {
                    if (!emotionSelectorButtons || !selectedEmotionInput) return;
                    emotionSelectorButtons.innerHTML = '';
                    emotions.forEach(emotion => {
                        const button = document.createElement('button');
                        button.type = 'button'; 
                        button.classList.add('emotion-button');
                        button.dataset.emotionValue = emotion.value;
                        button.innerHTML = `<span class="emotion-icon">${emotion.icon}</span>${emotion.text}`;
                        
                        button.addEventListener('click', () => {
                            document.querySelectorAll('.emotion-button').forEach(btn => {
                                btn.classList.remove('selected');
                                btn.style.borderColor = 'var(--border-color)';
                                btn.style.backgroundColor = '#fff';
                            });
                            button.classList.add('selected');
                            button.style.borderColor = `var(${emotion.colorVar})`;
                            button.style.backgroundColor = emotion.selectedBg;
                            selectedEmotionInput.value = emotion.value;
                        });
                        emotionSelectorButtons.appendChild(button);
                    });
                }

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®æç”»
                function renderFilterSelects() {
                    if (!emotionFilter || !monthFilter) return;
                    
                    // æ„Ÿæƒ…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
                    emotionFilter.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
                    emotions.forEach(emotion => {
                        const option = document.createElement('option');
                        option.value = emotion.value;
                        option.textContent = `${emotion.icon} ${emotion.text}`;
                        emotionFilter.appendChild(option);
                    });
                    
                    // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆè¨˜éŒ²ãŒã‚ã‚‹æœˆã®ã¿ï¼‰
                    updateMonthFilter();
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    emotionFilter.addEventListener('change', () => {
                        currentEmotionFilter = emotionFilter.value;
                        renderDiaryList();
                    });
                    
                    monthFilter.addEventListener('change', () => {
                        currentMonthFilter = monthFilter.value;
                        renderDiaryList();
                    });
                }

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æ›´æ–°ï¼ˆè¨˜éŒ²ãŒã‚ã‚‹æœˆã®ã¿è¡¨ç¤ºï¼‰
                function updateMonthFilter() {
                    if (!monthFilter) return;
                    
                    monthFilter.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
                    
                    // è¨˜éŒ²ãŒã‚ã‚‹æœˆã‚’æŠ½å‡º
                    const months = new Set();
                    diaries.forEach(diary => {
                        const date = new Date(diary.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        months.add(monthKey);
                    });
                    
                    // æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆæ–°ã—ã„é †ï¼‰
                    Array.from(months).sort().reverse().forEach(monthKey => {
                        const [year, month] = monthKey.split('-');
                        const option = document.createElement('option');
                        option.value = monthKey;
                        option.textContent = `${year}å¹´${parseInt(month)}æœˆ`;
                        monthFilter.appendChild(option);
                    });
                }

                // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                function handlePhotoUpload(file) {
                    if (!file || !file.type.startsWith('image/')) {
                        displayUserMessage('error-log-display', 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
                        return;
                    }

                    fileToBase64(file).then(base64 => {
                        selectedPhoto = base64;
                        showPhotoPreview(base64);
                    }).catch(error => {
                        console.error('å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                        displayUserMessage('error-log-display', 'å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                    });
                }

                // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                function showPhotoPreview(base64) {
                    photoPreviewContainer.innerHTML = `
                        <img src="${base64}" alt="é¸æŠã•ã‚ŒãŸå†™çœŸ" class="photo-preview">
                        <button type="button" class="photo-remove-button" onclick="removePhoto()">å‰Šé™¤</button>
                    `;
                }

                // å†™çœŸå‰Šé™¤
                window.removePhoto = function() {
                    selectedPhoto = null;
                    photoPreviewContainer.innerHTML = '';
                };

                // å†™çœŸé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                if (photoInput) {
                    photoInput.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            handlePhotoUpload(e.target.files[0]);
                        }
                    });
                }

                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
                if (photoUploadArea) {
                    photoUploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        photoUploadArea.classList.add('dragover');
                    });

                    photoUploadArea.addEventListener('dragleave', () => {
                        photoUploadArea.classList.remove('dragover');
                    });

                    photoUploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        photoUploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files[0]) {
                            handlePhotoUpload(e.dataTransfer.files[0]);
                        }
                    });
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
                if (modalClose) {
                    modalClose.addEventListener('click', () => {
                        photoModal.style.display = 'none';
                    });
                }

                if (photoModal) {
                    photoModal.addEventListener('click', (e) => {
                        if (e.target === photoModal) {
                            photoModal.style.display = 'none';
                        }
                    });
                }

                // æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
                async function loadDiariesFromStorage() {
                    console.log("loadDiariesFromStorage: èª­ã¿è¾¼ã¿é–‹å§‹");
                    try {
                        diaries = await storage.getAllDiaries();
                        console.log("æ—¥è¨˜ã‚’IndexedDBã‹ã‚‰ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:", diaries.length, "ä»¶");
                    } catch (e) {
                        console.error("IndexedDBèª­ã¿è¾¼ã¿å¤±æ•—:", e);
                        diaries = [];
                        displayUserMessage('error-log-display', "è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚", true);
                    }
                }

                // æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
                async function saveDiaryToStorage(diary) {
                    console.log("saveDiaryToStorage: ä¿å­˜é–‹å§‹", diary);
                    try {
                        await storage.saveDiary(diary);
                        console.log("æ—¥è¨˜ã‚’IndexedDBã«ä¿å­˜æˆåŠŸ");
                    } catch (e) {
                        console.error("IndexedDBä¿å­˜å¤±æ•—:", e);
                        displayUserMessage('error-log-display', "è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã€‚", true);
                        throw e;
                    }
                }

                // æ—¥è¨˜å‰Šé™¤
                async function deleteDiary(diaryId) {
                    console.log("deleteDiary: å‰Šé™¤é–‹å§‹, ID:", diaryId);
                    try {
                        await storage.deleteDiary(diaryId);
                        const index = diaries.findIndex(diary => diary.id === diaryId);
                        if (index !== -1) {
                            diaries.splice(index, 1);
                            updateMonthFilter(); // å‰Šé™¤æ™‚ã«æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                            renderDiaryList();
                            displayUserMessage('info-display', "ãã‚ãã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                            console.log("æ—¥è¨˜å‰Šé™¤å®Œäº†");
                        }
                    } catch (e) {
                        console.error("æ—¥è¨˜å‰Šé™¤å¤±æ•—:", e);
                        displayUserMessage('error-log-display', "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
                    }
                }

                // æ—¥è¨˜ä¸€è¦§ã®æç”»
                function renderDiaryList() {
                    if (!diaryListUl) { 
                        console.error("renderDiaryList: diaryListUl is null!"); 
                        return; 
                    }
                    
                    diaryListUl.innerHTML = '';
                    console.log("renderDiaryList: æç”»é–‹å§‹ã€‚ç¾åœ¨ã®diariesé…åˆ—ã®ä»¶æ•°:", diaries.length);

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                    let filteredDiaries = diaries;
                    
                    // æ„Ÿæƒ…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    if (currentEmotionFilter !== 'all') {
                        filteredDiaries = filteredDiaries.filter(diary => diary.emotion === currentEmotionFilter);
                    }
                    
                    // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    if (currentMonthFilter !== 'all') {
                        filteredDiaries = filteredDiaries.filter(diary => {
                            const date = new Date(diary.date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            return monthKey === currentMonthFilter;
                        });
                    }

                    if (filteredDiaries.length === 0) {
                        let message = 'ã¾ã ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                        if (currentEmotionFilter !== 'all' || currentMonthFilter !== 'all') {
                            message = 'æ¡ä»¶ã«åˆã†ãã‚ããŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                        }
                        diaryListUl.innerHTML = `<li class="no-diary-message">${message}</li>`;
                        return;
                    }

                    const sortedDiaries = [...filteredDiaries].sort((a, b) => new Date(b.date) - new Date(a.date));

                    sortedDiaries.forEach(diary => {
                        const li = document.createElement('li');
                        const emotionData = emotions.find(e => e.value === diary.emotion);
                        const emotionColor = emotionData ? `var(${emotionData.colorVar})` : 'var(--emotion-neutral)';
                        const emotionIcon = emotionData ? emotionData.icon : "â”";

                        const date = new Date(diary.date);
                        const weekday = getWeekday(date);
                        const formattedDate = `${date.toLocaleString('ja-JP', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour:'2-digit', 
                            minute:'2-digit' 
                        })} (${weekday})`;
                        
                        li.style.borderLeftColor = emotionColor;

                        const emotionIconDiv = document.createElement('div');
                        emotionIconDiv.classList.add('entry-emotion-icon-display');
                        emotionIconDiv.innerHTML = emotionIcon;

                        const textContentDiv = document.createElement('div');
                        textContentDiv.classList.add('entry-text-content');
                        
                        let contentHTML = `<p class="entry-memo-text">${sanitizeHTML(diary.memo) || "(ã²ã¨ã“ã¨ãªã—)"}</p>`;
                        
                        if (diary.photo) {
                            contentHTML += `<img src="${diary.photo}" alt="å†™çœŸ" class="entry-photo" onclick="showPhotoModal('${diary.photo}')">`;
                        }
                        
                        contentHTML += `<p class="entry-date">${formattedDate}</p>`;
                        
                        textContentDiv.innerHTML = contentHTML;

                        const actionsDiv = document.createElement('div');
                        actionsDiv.classList.add('entry-actions');
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('delete-button');
                        deleteButton.textContent = 'å‰Šé™¤';
                        deleteButton.addEventListener('click', () => {
                            if (confirm('ã“ã®ãã‚ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                deleteDiary(diary.id);
                            }
                        });
                        actionsDiv.appendChild(deleteButton);

                        li.appendChild(emotionIconDiv);
                        li.appendChild(textContentDiv);
                        li.appendChild(actionsDiv);

                        diaryListUl.appendChild(li);
                    });
                    console.log("æ—¥è¨˜ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†ã€‚");
                }

                // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                window.showPhotoModal = function(photoSrc) {
                    modalImage.src = photoSrc;
                    photoModal.style.display = 'block';
                };
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
                if (diaryForm) {
                    diaryForm.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        clearMessages();
                        console.log("ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†é–‹å§‹");

                        const emotion = selectedEmotionInput.value;
                        const memo = diaryMemoInput.value.trim();

                        if (!emotion) {
                            displayUserMessage('error-log-display', "ãã‚‚ã¡ã‚’é¸ã‚“ã§ãã ã•ã„ã­ã€‚", true);
                            return;
                        }

                        const newEntry = {
                            id: Date.now().toString(),
                            emotion: emotion,
                            memo: memo,
                            photo: selectedPhoto,
                            date: new Date().toISOString()
                        };

                        try {
                            await saveDiaryToStorage(newEntry);
                            diaries.unshift(newEntry);
                            updateMonthFilter(); // æ–°ã—ã„è¨˜éŒ²è¿½åŠ æ™‚ã«æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                            renderDiaryList();
                            
                            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                            diaryForm.reset();
                            document.querySelectorAll('.emotion-button').forEach(btn => {
                                btn.classList.remove('selected');
                                btn.style.borderColor = 'var(--border-color)';
                                btn.style.backgroundColor = '#fff';
                            });
                            if(selectedEmotionInput) selectedEmotionInput.value = '';
                            selectedPhoto = null;
                            photoPreviewContainer.innerHTML = '';
                            
                            displayUserMessage('info-display', "ãã‚‚ã¡ã‚’ã®ã“ã—ã¾ã—ãŸã€‚");
                        } catch (error) {
                            console.error("æ—¥è¨˜ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                            displayUserMessage('error-log-display', "ãã‚ãã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
                        }
                    });
                } else {
                    console.error("æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒ (#diary-form)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                }

                // --- åˆæœŸåŒ– ---
                try {
                    console.log("åˆæœŸåŒ–å‡¦ç† (ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç‰ˆ) é–‹å§‹");
                    renderEmotionButtons();
                    renderFilterSelects();
                    await loadDiariesFromStorage();
                    updateMonthFilter(); // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å†æ›´æ–°
                    renderDiaryList();
                    console.log("åˆæœŸåŒ–å‡¦ç† (ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç‰ˆ) å®Œäº†");
                } catch (e) {
                    console.error("åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
                    if(errorLogDisplay) displayUserMessage('error-log-display', "ãƒšãƒ¼ã‚¸ã®æº–å‚™ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", true);
                }
            });
        } catch (e) {
            console.error("DOMContentLoadedã‚ˆã‚Šå‰ã®ã‚¨ãƒ©ãƒ¼:", e);
            alert("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã®åˆæœŸæ®µéšã§é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    </script>
</body>
</html>
